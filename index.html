<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suno Playground</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-page: #0E1117; --bg-card: #161B22; --bg-input: #0E1117;
            --border: #30363D; --text-primary: #E6EDF3; --text-secondary: #8B949E;
            --accent-blue: #3882F6; --accent-blue-hover: #58A6FF; --accent-blue-active: #2188ff;
            --accent-green: #238636; --accent-red: #da3633;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: var(--bg-page); color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            padding: 30px; display: flex; justify-content: center;
        }
        .page-container { width: 100%; max-width: 1200px; display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        .header { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .header h1 { font-size: 24px; font-weight: 600; }
        .header p { font-size: 14px; color: var(--text-secondary); }
        .card { background-color: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 24px; display: flex; flex-direction: column; }
        .main-card { grid-column: 1 / 2; }
        .library-card { grid-column: 2 / 3; position: relative; }
        .tabs { display: flex; margin-bottom: 24px; border-bottom: 1px solid var(--border); flex-wrap: wrap; }
        .tab-button {
            position: relative; background: none; border: none; color: var(--text-secondary); padding: 0 4px 12px 4px; margin: 0 12px;
            cursor: pointer; font-size: 14px; font-weight: 500; border-bottom: 2px solid transparent; transition: color 0.2s, border-color 0.2s;
        }
        .tab-button:first-child { margin-left: 0; }
        .tab-button:hover { color: var(--text-primary); }
        .tab-button.active { color: var(--text-primary); border-bottom-color: var(--accent-blue); font-weight: 600; }
        .notification-dot {
            display: none; position: absolute; top: -2px; right: -8px; width: 8px; height: 8px;
            background-color: var(--accent-red); border-radius: 50%; border: 2px solid var(--bg-card);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out forwards; }
        .tab-content.exiting { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeOut { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(5px); } }
        .form-grid { display: flex; flex-direction: column; gap: 20px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; transition: opacity 0.3s, height 0.3s; }
        .form-group input, .form-group textarea, .form-group select {
            background-color: var(--bg-input); border: 1px solid var(--border); border-radius: 6px;
            color: var(--text-primary); padding: 10px 12px; font-size: 14px; width: 100%; transition: border-color 0.2s, box-shadow 0.2s;
        }
        .form-group input::placeholder, .form-group textarea::placeholder { color: var(--text-secondary); }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            border-color: var(--accent-blue); outline: none; box-shadow: 0 0 0 3px rgba(56, 130, 246, 0.3);
        }
        .form-group .input-error {
            border-color: var(--accent-red);
            box-shadow: 0 0 0 3px rgba(218, 54, 51, 0.3);
        }
        .form-group textarea { resize: vertical; min-height: 120px; }
        .form-row { display: flex; justify-content: space-between; align-items: center; }
        .char-counter { text-align: right; font-size: 12px; color: var(--text-secondary); margin-top: -4px; }
        .submit-button {
            background-color: var(--accent-blue); border: 1px solid var(--accent-blue); border-radius: 6px; padding: 10px;
            font-weight: 600; color: white; font-size: 14px; width: 100%; cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s, transform 0.1s;
        }
        .submit-button:hover { background-color: var(--accent-blue-hover); }
        .submit-button:active { transform: scale(0.98) translateY(1px); }
        .toggle-switch { display: flex; align-items: center; gap: 12px; color: var(--text-primary); font-size: 14px; font-weight: 500; }
        .toggle-switch input { display: none; }
        .toggle-switch .slider {
            position: relative; width: 38px; height: 22px; background-color: #30363D;
            border-radius: 11px; cursor: pointer; transition: background-color 0.2s;
        }
        .toggle-switch .slider::before {
            content: ''; position: absolute; left: 2px; top: 2px; width: 18px; height: 18px;
            background-color: white; border-radius: 50%; transition: transform 0.2s;
        }
        .toggle-switch input:checked + .slider { background-color: var(--accent-blue); }
        .toggle-switch input:checked + .slider::before { transform: translateX(16px); }
        .card h4 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
        #logs-content pre {
            background-color: var(--bg-input); padding: 16px; border: 1px solid var(--border);
            border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; font-size: 13px; max-height: 80vh; overflow-y: auto; line-height: 1.6;
        }
        .credits-display {
            background-color: var(--bg-card); border: 1px solid var(--border); color: var(--text-secondary); padding: 8px 12px; border-radius: 8px;
            font-size: 14px; font-weight: 500; display: inline-flex; align-items: center; gap: 6px;
        }
        .credits-display .credits-value { color: var(--text-primary); font-weight: 700; margin-right: 4px; }
        .credits-display .credits-icon svg { display: block; width: 16px; height: 16px; }
        .custom-select-wrapper { position: relative; width: 100px; user-select: none; }
        .select-button {
            background-color: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-primary);
            padding: 8px 12px; font-size: 14px; font-weight: 500; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
        }
        .select-button::after {
            content: ''; border: solid var(--text-secondary); border-width: 0 2px 2px 0; display: inline-block; padding: 3px; transform: rotate(45deg); transition: transform 0.2s;
        }
        .select-dropdown.open ~ .select-button::after { transform: rotate(-135deg); }
        .select-dropdown {
            position: absolute; top: calc(100% + 4px); left: 0; right: 0; background-color: #21262d;
            border: 1px solid var(--border); border-radius: 6px; padding: 4px; z-index: 10; display: none;
        }
        .select-dropdown.open { display: block; }
        .select-option { padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .select-option:hover { background-color: #30363d; }
        .select-option.selected { background-color: var(--accent-blue-active); font-weight: 600; }
        select {
            -webkit-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%238B949E' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708 .708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 12px center; padding-right: 30px;
        }
        .status-message {
            background-color: var(--bg-input); border: 1px solid var(--border); padding: 12px;
            border-radius: 6px; font-weight: 500; color: var(--text-secondary); margin-bottom: 16px;
        }
        .status-message.success { border-left: 4px solid var(--accent-green); color: var(--text-primary); }
        .status-message.error { border-left: 4px solid var(--accent-red); color: var(--text-primary); }
        hr.divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }
        #song-list-container { display: flex; flex-direction: column; gap: 16px; overflow-y: auto; padding-right: 10px; flex-grow: 1; }
        .song-card { display: flex; align-items: flex-start; gap: 16px; }
        .song-card.placeholder { opacity: 0.6; align-items: center; }
        .song-cover {
            width: 80px; height: 80px; border-radius: 8px; cursor: pointer;
            position: relative; overflow: hidden; flex-shrink: 0;
            background-color: var(--bg-input);
        }
        .song-cover img { width: 100%; height: 100%; object-fit: cover; }
        .song-cover .play-icon {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 32px; height: 32px; background-color: rgba(0,0,0,0.5); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            color: white; opacity: 0; transition: opacity 0.2s;
        }
        .song-cover:hover .play-icon, .song-cover.playing .play-icon, .song-cover.paused .play-icon { opacity: 1; }
        .song-duration {
            position: absolute; bottom: 4px; right: 4px; background-color: rgba(0, 0, 0, 0.7);
            color: white; font-size: 11px; font-weight: 600; padding: 2px 5px; border-radius: 4px;
        }
        .song-info { display: flex; flex-direction: column; gap: 4px; flex-grow: 1; min-width: 0; }
        .song-title { font-size: 16px; font-weight: 600; color: var(--text-primary); }
        .song-model-tag {
            background-color: var(--border); color: var(--text-secondary); font-size: 11px;
            font-weight: 600; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-left: 8px; vertical-align: middle;
        }
        .song-style { font-size: 14px; color: var(--text-secondary); word-break: break-word; }
        .song-style-content.collapsed {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .toggle-description-btn {
            background: none; border: none; color: var(--accent-blue-hover); cursor: pointer;
            font-size: 12px; padding: 4px 0; font-weight: 600;
        }
        .download-button {
            background-color: #21262d; color: var(--text-primary); border: 1px solid var(--border);
            text-decoration: none; padding: 6px 12px; border-radius: 6px; font-size: 13px;
            font-weight: 500; transition: background-color 0.2s, color 0.2s; white-space: nowrap; cursor: pointer;
        }
        .download-button:hover { background-color: #30363d; }
        #empty-list-message { color: var(--text-secondary); text-align: center; padding: 20px; }
        .progress-bar-container { width: 100%; background-color: var(--border); border-radius: 4px; height: 6px; overflow: hidden; margin-top: 8px; }
        .progress-bar-inner { width: 0%; height: 100%; background-color: var(--accent-blue); transition: width 0.5s ease; }
        
        #global-player-container {
            position: sticky; bottom: 0; left: 0; right: 0; background-color: #1c2128;
            border-top: 1px solid var(--border); padding: 12px 16px;
            display: none; align-items: center; gap: 12px;
            margin: 16px -24px -24px -24px; border-radius: 0 0 8px 8px;
        }
        #player-cover { width: 48px; height: 48px; border-radius: 4px; flex-shrink: 0; }
        #player-info { flex-grow: 1; font-size: 14px; color: var(--text-primary); min-width: 0; }
        #player-title { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #player-controls { display: flex; align-items: center; gap: 10px; }
        #play-pause-btn { background: none; border: none; color: var(--text-primary); cursor: pointer; }
        .time-display { font-size: 12px; color: var(--text-secondary); width: 40px; text-align: center; }
        #seek-bar {
            flex-grow: 1; -webkit-appearance: none; appearance: none;
            width: 100%; height: 5px; background: var(--border);
            outline: none; border-radius: 3px; cursor: pointer;
        }
        #seek-bar::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 14px; height: 14px; background: var(--text-primary);
            border-radius: 50%; cursor: pointer;
        }

        @media (max-width: 900px) { .page-container { grid-template-columns: 1fr; } .main-card, .library-card { grid-column: auto; } }
    </style>
</head>
<body>

    <div class="page-container">
        <header class="header">
            <div><h1>Suno Playground</h1><p>Тестируйте API с помощью форм и получайте ответы в реальном времени.</p></div>
            <div id="credits-container" class="credits-display" style="display: none;">
                <span class="credits-value" id="credits-value">...</span>
                <span class="credits-icon"><svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path fill="#f7b731" d="M9.91 15.42c-1.2.7-2.62.7-3.82 0L2.14 13.1c-1.2-.7-1.95-2-1.95-3.37V6.27c0-1.37.75-2.67 1.95-3.37L6.09 0.58c1.2-.7 2.62-.7 3.82 0l3.95 2.32c1.2.7 1.95 2 1.95 3.37v3.46c0 1.37-.75 2.67-1.95 3.37l-3.95 2.32z"></path><path fill="#ffffff" d="M8 10.87a.6.6 0 01-.35-.11L5.5 9.53a.6.6 0 01-.22-.8l.74-2.16-1.63-1.63a.6.6 0 01.16-.94l2.16-.73L7.9 1.1a.6.6 0 011.08.38l.73 2.16 2.16.73a.6.6 0 01.16.94L10.4 7.57l.74 2.16a.6.6 0 01-.22.8l-2.15 1.23a.6.6 0 01-.35.11z"></path></svg></span>
            </div>
        </header>

        <div class="card main-card">
            <div class="tabs">
                <button class="tab-button active" onclick="openTab(event, 'generate')">Создать</button>
                <button class="tab-button" onclick="openTab(event, 'extend')">Продлить</button>
                <button class="tab-button" onclick="openTab(event, 'upload')">Загрузить</button>
                <button class="tab-button" id="logs-tab-button" onclick="openTab(event, 'logs')">Логи<span id="logs-notification-dot" class="notification-dot"></span></button>
            </div>

            <div id="generate" class="tab-content active">
                <form id="generate-music-form" class="form-grid">
                    <div class="form-row"><label class="toggle-switch"><input type="checkbox" id="g-customMode" checked><span class="slider"></span><span>Пользовательский режим</span></label><div class="custom-select-wrapper"><input type="hidden" id="g-model-value" value="V4_5PLUS"><div class="select-button" id="select-model-button">V4.5+</div><div class="select-dropdown" id="select-model-dropdown"><div class="select-option selected" data-value="V4_5PLUS">V4.5+</div><div class="select-option" data-value="V4_5">V4.5</div><div class="select-option" data-value="V4">V4</div><div class="select-option" data-value="V3_5">V3.5</div></div></div></div>
                    <div id="simple-mode-fields" class="form-grid" style="display: none;"><div class="form-group" id="g-song-description-group"><label for="g-song-description">Описание песни</label><textarea id="g-song-description" placeholder="Опишите стиль музыки, тему и настроение..."></textarea></div></div>
                    <div id="custom-mode-fields" class="form-grid">
                        <div class="form-group"><label for="g-title">Название</label><input type="text" id="g-title" placeholder="Введите название"></div>
                        <div class="form-group"><label for="g-style">Стиль музыки</label><textarea id="g-style" oninput="updateCharCounter(this, 'g-style-counter')"></textarea><div id="g-style-counter" class="char-counter"></div></div>
                        <div class="form-group" id="g-prompt-group"><label for="g-prompt">Текст песни</label><textarea id="g-prompt" oninput="updateCharCounter(this, 'g-prompt-counter')"></textarea><div id="g-prompt-counter" class="char-counter"></div></div>
                        <hr class="divider">
                        <label class="toggle-switch"><input type="checkbox" id="g-instrumental"><span class="slider"></span><span>Инструментал</span></label>
                        <div class="form-group"><label for="g-negativeTags">Негативные теги</label><input type="text" id="g-negativeTags" placeholder="Heavy Metal, Upbeat Drums"></div>
                        <div class="form-group"><label for="g-vocalGender">Пол вокала</label><select id="g-vocalGender"><option value="">Не выбрано</option><option value="m">Мужской</option><option value="f">Женский</option></select></div>
                    </div>
                    <button type="submit" class="submit-button" id="g-submit-button">Сгенерировать музыку</button>
                </form>
            </div>
            
            <div id="extend" class="tab-content"><form id="extend-music-form" class="form-grid"><div class="form-group"><label for="e-audioId">Audio ID</label><input type="text" id="e-audioId" placeholder="ID трека для продления" required></div><div class="form-group"><label for="e-continueAt">Продлить с (секунды)</label><input type="number" id="e-continueAt" value="60"></div><button type="submit" class="submit-button">Продлить трек</button></form></div>
            <div id="upload" class="tab-content"><div class="form-grid"><form id="upload-cover-form" class="form-grid"><div class="form-group"><label for="uc-uploadUrl">URL загруженного аудио</label><input type="text" id="uc-uploadUrl" placeholder="https://storage.example.com/audio.mp3" required></div><div class="form-group"><label for="uc-prompt">Prompt (описание кавера)</label><textarea id="uc-prompt" placeholder="A calm and relaxing piano track..."></textarea></div><button type="submit" class="submit-button">Создать кавер</button></form><hr class="divider"><form id="upload-extend-form" class="form-grid"><div class="form-group"><label for="ue-uploadUrl">URL загруженного аудио</label><input type="text" id="ue-uploadUrl" placeholder="https://storage.example.com/audio.mp3" required></div><div class="form-group"><label for="ue-continueAt">Продлить с (секунды)</label><input type="number" id="ue-continueAt" value="60"></div><button type="submit" class="submit-button">Продлить загруженное</button></form></div></div>
            
            <div id="logs" class="tab-content">
                <div id="logs-content">
                    <h4>Статус операции</h4>
                    <div id="status-container"><p class="status-message">Ожидание запуска задачи...</p></div>
                    <h4>Ответ API</h4>
                    <pre id="response-output">Ожидание вызова API...</pre>
                </div>
            </div>
        </div>

        <div class="card library-card">
            <h4>Библиотека</h4>
            <hr class="divider">
            <div id="song-list-container">
                <p id="empty-list-message">Здесь будут отображаться ваши сгенерированные песни.</p>
            </div>
            <div id="global-player-container">
                <audio id="global-audio-player"></audio>
                <img id="player-cover" src="" alt="cover">
                <div id="player-info">
                    <div id="player-title"></div>
                    <input type="range" id="seek-bar" value="0" step="1">
                </div>
                <div id="player-controls">
                    <span id="current-time" class="time-display">0:00</span>
                    <button id="play-pause-btn">
                        <svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                    </button>
                    <span id="total-duration" class="time-display">0:00</span>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ---
    let pollingInterval; let currentTabName = 'generate';
    const modelMap = { "V4_5PLUS": "V4.5+", "V4_5": "V4.5", "V4": "V4", "V3_5": "V3.5" };
    const LOCAL_STORAGE_KEY = 'sunoPlaygroundSongs';

    // --- ИНИЦИАЛИЗАЦИЯ ЭЛЕМЕНТОВ ---
    const customModeToggle=document.getElementById("g-customMode"),simpleModeFields=document.getElementById("simple-mode-fields"),customModeFields=document.getElementById("custom-mode-fields"),modelValueInput=document.getElementById("g-model-value"),selectButton=document.getElementById("select-model-button"),selectDropdown=document.getElementById("select-model-dropdown"),styleTextarea=document.getElementById("g-style"),promptTextarea=document.getElementById("g-prompt"),instrumentalToggle=document.getElementById("g-instrumental"),promptGroup=document.getElementById("g-prompt-group"),descriptionGroup=document.getElementById("g-song-description-group"),statusContainer=document.getElementById("status-container"),songListContainer = document.getElementById('song-list-container'), emptyListMessage = document.getElementById('empty-list-message'), logsNotificationDot = document.getElementById('logs-notification-dot');
    const globalPlayer={container:document.getElementById("global-player-container"),audio:document.getElementById("global-audio-player"),cover:document.getElementById("player-cover"),title:document.getElementById("player-title"),seekBar:document.getElementById("seek-bar"),playPauseBtn:document.getElementById("play-pause-btn"),currentTime:document.getElementById("current-time"),totalDuration:document.getElementById("total-duration"),currentSongId:null};
    
    // --- LOCALSTORAGE & HELPERS ---
    const storage = {
        getSongs: () => JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || [],
        saveSong: (songData, requestParams) => {
            const songs = storage.getSongs();
            if (!songs.some(s => s.songData.id === songData.id)) {
                songs.push({ songData, requestParams });
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(songs));
            }
        }
    };
    function formatTime(seconds) { if(isNaN(seconds)||seconds===null||!isFinite(seconds))return'--:--';const m=Math.floor(seconds/60),s=Math.floor(seconds%60);return`${m}:${s<10?"0":""}${s}`;}

    // --- ЛОГИКА ПЛЕЕРА ---
    function playSong(songData) {
        document.querySelectorAll('.song-cover').forEach(el=>el.classList.remove('playing','paused'));
        const coverEl=document.getElementById(`cover-${songData.id}`);
        if(globalPlayer.currentSongId===songData.id&&!globalPlayer.audio.paused){
            globalPlayer.audio.pause();
            if(coverEl)coverEl.classList.add('paused');
        }else{
            if(globalPlayer.currentSongId!==songData.id){
                globalPlayer.audio.src=songData.streamAudioUrl;
                globalPlayer.currentSongId=songData.id;
                globalPlayer.cover.src=songData.imageUrl;
                globalPlayer.title.textContent=songData.title||'Без названия';
                globalPlayer.container.style.display='flex';
            }
            globalPlayer.audio.play();
            if(coverEl)coverEl.classList.add('playing');
        }
    }
    globalPlayer.playPauseBtn.onclick=()=>{if(globalPlayer.audio.paused)globalPlayer.audio.play();else globalPlayer.audio.pause();};
    globalPlayer.audio.onplay=()=>{globalPlayer.playPauseBtn.innerHTML=`<svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`;const coverEl=document.getElementById(`cover-${globalPlayer.currentSongId}`);if(coverEl)coverEl.classList.replace('paused','playing');};
    globalPlayer.audio.onpause=()=>{globalPlayer.playPauseBtn.innerHTML=`<svg viewBox="0 0 24 24" width="28" height="28" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>`;const coverEl=document.getElementById(`cover-${globalPlayer.currentSongId}`);if(coverEl)coverEl.classList.replace('playing','paused');};
    globalPlayer.audio.onloadedmetadata=()=>{globalPlayer.seekBar.max=globalPlayer.audio.duration;globalPlayer.totalDuration.textContent=formatTime(globalPlayer.audio.duration);};
    globalPlayer.audio.ontimeupdate=()=>{globalPlayer.seekBar.value=globalPlayer.audio.currentTime;globalPlayer.currentTime.textContent=formatTime(globalPlayer.audio.currentTime);};
    globalPlayer.seekBar.oninput=()=>(globalPlayer.audio.currentTime=globalPlayer.seekBar.value);

    // --- ЛОГИКА ИНТЕРФЕЙСА ---
    async function downloadSong(event, url, filename) {
        event.preventDefault();
        const button = event.currentTarget;
        const originalText = button.textContent;
        button.textContent = 'Скачивание...';
        button.style.cursor = 'wait';
        try {
            const response = await fetch(url);
            const blob = await response.blob();
            const blobUrl = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = blobUrl;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(blobUrl);
            a.remove();
        } catch (error) {
            console.error('Download failed:', error);
            button.textContent = 'Ошибка';
        } finally {
            setTimeout(() => {
                button.textContent = originalText;
                button.style.cursor = 'pointer';
            }, 1000);
        }
    }

    function addSongToList(songData, requestParams, shouldSave = true) {
        if (shouldSave) storage.saveSong(songData, requestParams);
        if (emptyListMessage) emptyListMessage.style.display = 'none';
        const card = document.createElement('div');
        card.className = 'song-card';
        card.id = `song-${songData.id}`;
        let friendlyModelName = 'v4';
        try { const params = JSON.parse(requestParams); friendlyModelName = modelMap[params.model] || params.model; } catch(e) {}
        const downloadUrl = songData.audioUrl || songData.streamAudioUrl;
        const filename = `${songData.title || 'track'}.mp3`;
        card.innerHTML = `<div class="song-cover" id="cover-${songData.id}"><img src="${songData.imageUrl}" alt="Обложка трека"><div class="song-duration" id="duration-${songData.id}">--:--</div><div class="play-icon"><svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg></div></div><div class="song-info"><div><span class="song-title">${songData.title || 'Без названия'}</span><span class="song-model-tag">${friendlyModelName}</span></div><div class="song-style"><div class="song-style-content" id="style-${songData.id}">${songData.tags || '(no styles)'}</div></div></div><button class="download-button">Скачать</button>`;
        card.querySelector('.song-cover').onclick = () => playSong(songData);
        card.querySelector('.download-button').onclick = (e) => downloadSong(e, downloadUrl, filename);
        songListContainer.prepend(card);
        setTimeout(() => {
            const styleContent = card.querySelector(`#style-${songData.id}`);
            if (styleContent.scrollHeight > styleContent.clientHeight) {
                styleContent.classList.add('collapsed');
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'toggle-description-btn';
                toggleBtn.textContent = '[ развернуть ]';
                toggleBtn.onclick = () => { const isCollapsed = styleContent.classList.toggle('collapsed'); toggleBtn.textContent = isCollapsed ? '[ развернуть ]' : '[ свернуть ]'; };
                styleContent.parentElement.appendChild(toggleBtn);
            }
        }, 10);
        const tempAudio = new Audio(songData.streamAudioUrl);
        tempAudio.addEventListener('loadedmetadata', () => { const durationEl = document.getElementById(`duration-${songData.id}`); if (durationEl) durationEl.textContent = formatTime(tempAudio.duration); });
    }

    function createPlaceholderCard(taskId) {
        if (emptyListMessage) emptyListMessage.style.display = 'none';
        const card = document.createElement('div');
        card.className = 'song-card placeholder';
        card.id = `placeholder-${taskId}`;
        card.innerHTML = `<div class="song-cover"><div class="song-duration">--:--</div></div><div class="song-info"><span class="song-title">Генерация...</span><span class="song-style">Пожалуйста, подождите</span><div class="progress-bar-container"><div class="progress-bar-inner" id="progress-${taskId}"></div></div></div>`;
        songListContainer.prepend(card);
    }
    
    function handleTaskError(taskId, errorMessage) {
        if (pollingInterval) clearInterval(pollingInterval);
        updateStatus(`🚫 Ошибка: ${errorMessage || 'Неизвестная ошибка'}`, false, true);
        logsNotificationDot.style.display = 'block';
        const placeholder = document.getElementById(`placeholder-${taskId}`);
        if (placeholder) {
            placeholder.classList.remove('placeholder');
            const progressBar = document.getElementById(`progress-${taskId}`);
            if (progressBar) { progressBar.style.width = '100%'; progressBar.style.backgroundColor = 'var(--accent-red)'; }
            const titleEl = placeholder.querySelector('.song-title');
            if (titleEl) titleEl.textContent = 'Ошибка генерации';
            const styleEl = placeholder.querySelector('.song-style');
            if (styleEl) styleEl.textContent = 'Подробности в логах';
        }
    }

    function startPolling(taskId) {
        if (pollingInterval) clearInterval(pollingInterval);
        createPlaceholderCard(taskId);
        updateStatus(`⏳ Задача ${taskId.slice(0,8)}... в очереди. Начинаем проверку...`);
        let progress = 0;
        
        pollingInterval = setInterval(async () => {
            const progressBar = document.getElementById(`progress-${taskId}`);
            if (progress < 95) { progress += 5; if(progressBar) progressBar.style.width = `${progress}%`; }
            
            try {
                const response = await fetch(`/api/task-status/${taskId}`);
                const result = await response.json();
                document.getElementById("response-output").textContent = JSON.stringify(result, null, 2);
                if (!response.ok) { handleTaskError(taskId, result.message || `Ошибка сервера: ${response.status}`); return; }
                if (!result.data) { handleTaskError(taskId, "Получен некорректный ответ от API (отсутствует поле 'data')."); return; }
                const taskData = result.data;
                const statusLowerCase = taskData.status.toLowerCase();
                const successStates = ["success", "completed"];
                const pendingStates = ["pending", "running", "submitted", "queued", "text_success", "first_success"];

                if (successStates.includes(statusLowerCase)) {
                    clearInterval(pollingInterval);
                    if(progressBar) progressBar.style.width = `100%`;
                    updateStatus("✅ Задача выполнена!", true);
                    const placeholder = document.getElementById(`placeholder-${taskId}`);
                    if(placeholder) placeholder.remove();
                    if (taskData.response && Array.isArray(taskData.response.sunoData)) {
                        taskData.response.sunoData.forEach(song => {
                            addSongToList(song, taskData.param);
                        });
                        handleApiCall("/api/chat/credit", { method: "GET" }, true);
                    }
                } else if (pendingStates.includes(statusLowerCase)) {
                    updateStatus(`⏳ Статус: ${taskData.status}. Следующая проверка через 10 сек...`);
                } else {
                    handleTaskError(taskId, taskData.errorMessage || `API вернул статус сбоя: ${taskData.status}`);
                }
            } catch (error) { handleTaskError(taskId, "Сетевая ошибка или ошибка парсинга ответа."); }
        }, 10000);
    }

    function updateStatus(message, isSuccess = false, isError = false) { statusContainer.innerHTML = `<div class="status-message ${isSuccess ? 'success' : ''} ${isError ? 'error' : ''}">${message}</div>`; }
    selectButton.addEventListener("click",e=>{e.stopPropagation(),selectDropdown.classList.toggle("open")}),selectDropdown.addEventListener("click",e=>{e.target.classList.contains("select-option")&&(modelValueInput.value=e.target.dataset.value,selectButton.textContent=e.target.textContent,document.querySelectorAll(".select-option").forEach(e=>e.classList.remove("selected")),e.target.classList.add("selected"),updateCharacterLimits(modelValueInput.value))}),window.addEventListener("click",()=>{selectDropdown.classList.remove("open")});
    function toggleGeneratorMode(){ const isCustom = customModeToggle.checked; simpleModeFields.style.display = isCustom ? "none" : "flex"; customModeFields.style.display = isCustom ? "flex" : "none"; togglePromptVisibility(); }
    function togglePromptVisibility(){ promptGroup.style.display = instrumentalToggle.checked ? "none" : "flex"; descriptionGroup.style.display = instrumentalToggle.checked ? "none" : "flex"; }
    customModeToggle.addEventListener("change", toggleGeneratorMode);
    instrumentalToggle.addEventListener("change", togglePromptVisibility);
    function updateCharacterLimits(e){const t="V4_5"===e||"V4_5PLUS"===e?{style:1e3,prompt:5e3}:{style:200,prompt:3e3};styleTextarea.maxLength=t.style,promptTextarea.maxLength=t.prompt,updateCharCounter(styleTextarea,"g-style-counter"),updateCharCounter(promptTextarea,"g-prompt-counter")}
    document.getElementById("generate-music-form").addEventListener("submit", function(e) {
        e.preventDefault(); if (!validateGenerateForm()) { updateStatus('🚫 Пожалуйста, заполните все выделенные поля.', false, true); return; }
        let payload = { model: modelValueInput.value, instrumental: instrumentalToggle.checked, customMode: customModeToggle.checked };
        if (payload.customMode) {
            payload.title = document.getElementById("g-title").value; payload.style = styleTextarea.value; if (!payload.instrumental) payload.prompt = promptTextarea.value;
            const negativeTags = document.getElementById("g-negativeTags").value; if(negativeTags) payload.negativeTags = negativeTags;
            const vocalGender = document.getElementById("g-vocalGender").value; if (vocalGender) payload.vocalGender = vocalGender;
        } else { if (!payload.instrumental) payload.prompt = document.getElementById("g-song-description").value; }
        handleApiCall("/api/generate", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) }, false, true);
    });
    function updateCharCounter(e,t){const o=document.getElementById(t);o&&(o.textContent=`${e.value.length} / ${e.maxLength}`)}
    function openTab(event, tabName) {
        if (currentTabName === tabName) return;
        const currentActiveTab = document.getElementById(currentTabName);
        const newTab = document.getElementById(tabName);
        document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
        event.currentTarget.classList.add("active");
        if (currentActiveTab) {
            currentActiveTab.classList.add('exiting');
            const handleAnimationEnd = () => {
                currentActiveTab.classList.remove('active', 'exiting');
                currentActiveTab.style.display = 'none';
                newTab.style.display = 'block';
                newTab.classList.add('active');
                currentTabName = tabName;
            };
            currentActiveTab.addEventListener('animationend', handleAnimationEnd, { once: true });
        } else {
            newTab.style.display = 'block';
            newTab.classList.add('active');
            currentTabName = tabName;
        }
        if (tabName === 'logs') logsNotificationDot.style.display = 'none';
    }
    async function handleApiCall(endpoint, options, isCreditCheck = false, isGeneration = false) {
        const responseOutput = document.getElementById("response-output");
        if(!isCreditCheck) { statusContainer.innerHTML = '<p class="status-message">Ожидание запуска задачи...</p>'; responseOutput.textContent = "Выполняется запрос..."; }
        if (pollingInterval && !isCreditCheck) clearInterval(pollingInterval);
        try {
            const response = await fetch(endpoint, options);
            const result = await response.json();
            if (response.ok) {
                if(!isCreditCheck) responseOutput.textContent = JSON.stringify(result, null, 2);
                if (isCreditCheck && result.data !== undefined) { document.getElementById("credits-value").textContent = result.data; document.getElementById("credits-container").style.display = "inline-flex"; }
                if (isGeneration && result.data && result.data.taskId) { startPolling(result.data.taskId); } 
                else if (isGeneration) { updateStatus(`🚫 Ошибка запуска: ${result.message || 'Не удалось получить taskId.'}`, false, true); logsNotificationDot.style.display = 'block'; }
            } else {
                if(!isCreditCheck) responseOutput.textContent = `🚫 Ошибка ${response.status}:\n\n${JSON.stringify(result, null, 2)}`;
                updateStatus(`🚫 Ошибка запуска: ${result.message || 'Сервер вернул ошибку.'}`, false, true);
                logsNotificationDot.style.display = 'block';
            }
        } catch (error) {
            if(!isCreditCheck) responseOutput.textContent = "💥 Сетевая ошибка или ошибка парсинга JSON:\n\n" + error.message;
            updateStatus(`💥 Критическая ошибка: ${error.message}`, false, true);
            logsNotificationDot.style.display = 'block';
        }
    }
    const titleInput = document.getElementById('g-title'), styleInput = document.getElementById('g-style'), promptInput = document.getElementById('g-prompt'), descriptionInput = document.getElementById('g-song-description');
    function validateGenerateForm() {
        [titleInput, styleInput, promptInput, descriptionInput].forEach(el => el.classList.remove('input-error'));
        const isCustom = customModeToggle.checked, isInstrumental = instrumentalToggle.checked; let allValid = true;
        if (isCustom) {
            if (titleInput.value.trim() === '') { titleInput.classList.add('input-error'); allValid = false; }
            if (styleInput.value.trim() === '') { styleInput.classList.add('input-error'); allValid = false; }
            if (!isInstrumental && promptInput.value.trim() === '') { promptInput.classList.add('input-error'); allValid = false; }
        } else { if (!isInstrumental && descriptionInput.value.trim() === '') { descriptionInput.classList.add('input-error'); allValid = false; } }
        return allValid;
    }
    document.addEventListener("DOMContentLoaded", () => {
        toggleGeneratorMode();
        updateCharacterLimits(modelValueInput.value);
        handleApiCall("/api/chat/credit", { method: "GET" }, true);
        loadSongsFromLocalStorage();
    });
</script>

</body>
</html>