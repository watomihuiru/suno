# Отладка WebSocket для Midjourney

## Проблема
После успешной генерации фотографий через Midjourney WebSocket больше не обновляется при следующих запросах. Пользователь нажимает генерацию, получает ответ от API, что запрос принят, но дальше остается только ожидание статуса задачи без обновлений.

## Внесенные изменения

### 1. Клиентская часть (`js/api.js`)

Добавлены логи для отслеживания:
- Инициализации API вызовов
- Создания и закрытия WebSocket соединений
- Получения сообщений через WebSocket
- Обработки статусов задач Midjourney

**Ключевые точки логирования:**
```javascript
console.log(`[API Call] endpoint: ${endpoint}, isGeneration: ${isGeneration}, taskType: ${taskType}`);
console.log(`[startTaskTracking] taskId: ${taskId}, taskType: ${taskType}`);
console.log('[WebSocket] Соединение установлено, отправляем trackTask');
console.log('[WebSocket] Получено сообщение:', result);
console.log(`[WebSocket MJ] successFlag: ${taskData.successFlag}`);
```

### 2. Серверная часть (`server.js`)

Добавлены логи для отслеживания:
- Получения сообщений от клиента
- Начала отслеживания задач
- Статусов задач Midjourney
- Закрытия и ошибок WebSocket соединений

**Ключевые точки логирования:**
```javascript
console.log(`[WebSocket] Получено сообщение от пользователя ${userId}:`, data);
console.log(`[WebSocket] Начинаем отслеживание задачи ${taskId} типа ${taskType}`);
console.log(`[WebSocket MJ] Статус задачи ${taskId}: successFlag=${taskData.successFlag}`);
console.log(`[WebSocket] Соединение закрыто для пользователя ${userId}`);
```

**Важное исправление:**
После очистки интервала теперь явно устанавливается `trackingInterval = null`, чтобы предотвратить проблемы с повторным использованием.

## Как отлаживать

### 1. Откройте консоль браузера (F12)

Следите за логами в следующем порядке:

1. **При нажатии на генерацию:**
   ```
   [API Call] endpoint: /api/mj/generate, isGeneration: true, taskType: mj
   ```

2. **При получении taskId:**
   ```
   [API Call] Получен taskId: XXXXX, запуск отслеживания
   [startTaskTracking] taskId: XXXXX, taskType: mj
   [startTaskTracking] Создаём WebSocket: ws://localhost:3000?token=...
   ```

3. **При установке соединения:**
   ```
   [WebSocket] Соединение установлено, отправляем trackTask
   [WebSocket] Отправляем: {type: "trackTask", taskId: "...", taskType: "mj"}
   ```

4. **При получении обновлений:**
   ```
   [WebSocket] Получено сообщение: {data: {...}}
   [WebSocket MJ] successFlag: 0  // или другое значение
   ```

5. **При завершении:**
   ```
   [WebSocket MJ] Задача завершена, закрываем WebSocket
   [WebSocket] Соединение закрыто.
   ```

### 2. Проверьте логи сервера

В терминале, где запущен сервер, следите за логами:

```bash
[WebSocket] Получено сообщение от пользователя 1: { type: 'trackTask', taskId: '...', taskType: 'mj' }
[WebSocket] Начинаем отслеживание задачи ... типа mj
[WebSocket MJ] Статус задачи ...: successFlag=0
[WebSocket MJ] Статус задачи ...: successFlag=1
[WebSocket MJ] Задача ... завершена, очищаем интервал
[WebSocket MJ] Отправляем финальный ответ клиенту
[WebSocket] Соединение закрыто для пользователя 1
```

## Возможные проблемы

### 1. WebSocket не создается при втором запросе

**Симптомы:** 
- В консоли нет логов `[startTaskTracking]` при втором запросе
- Статус остается "Ожидание запуска задачи..."

**Проверить:**
- Приходит ли `taskId` в ответе API: ищите `[API Call] Получен taskId:`
- Если видите `[API Call] Ошибка: нет taskId в ответе`, значит проблема в API сервере

### 2. WebSocket создается, но не получает сообщений

**Симптомы:**
- Видите `[WebSocket] Соединение установлено`
- Не видите `[WebSocket] Получено сообщение`

**Проверить:**
- Логи сервера: есть ли `[WebSocket] Получено сообщение от пользователя`?
- Логи сервера: есть ли ошибки при запросе к API Midjourney?

### 3. WebSocket получает сообщения, но статус не меняется

**Симптомы:**
- Видите `[WebSocket] Получено сообщение`
- Статус остается "Генерация..." бесконечно

**Проверить:**
- Значение `successFlag` в логах
- Логи сервера: доходит ли до `[WebSocket MJ] Задача завершена`?

## Следующие шаги после отладки

После того, как проблема будет найдена с помощью логов, можно будет:
1. Удалить лишние `console.log` для production
2. Оставить только критичные логи для мониторинга
3. Применить исправление для конкретной найденной проблемы

## Запуск

```bash
# Установка зависимостей
npm install

# Запуск сервера
node server.js
```

Сервер запустится на `http://localhost:3000`